package com.partner.busi.model;

import java.util.ArrayList;
import java.util.List;

import com.jfinal.plugin.activerecord.Db;
import com.partner.busi.model.base.BaseGame;

/**
 * Generated by JFinal.
 */
@SuppressWarnings("serial")
public class Game extends BaseGame<Game> {
	public static final Game dao = new Game();
	
	/**
	 * 根据赛事ID删除所有比赛
	 * @param matchId
	 * @return
	 */
	public boolean deleteByMatchId(int matchId) {
		int rs = Db.update("delete from t_game where MATCH_ID = ?", matchId);
		if(rs==0){
			return false;
		}else{
			return true;
		}
	}
	
	/**
	 * 修改用户
	 * @param gameId
	 * @param userId
	 * @param userIndex
	 * @return
	 */
	public boolean updateUser(int gameId, Integer userId, int userIndex){
		int rs = Db.update("update t_game set USER"+userIndex+"=? where ID = ?", userId, gameId);
		return rs > 0;
	}
	
	/**
	 * 更新比分
	 * @param winId
	 * @param score1
	 * @param score2
	 * @return
	 */
	public boolean updateScore(int gameId, Integer winId, Integer score1, Integer score2){
		int rs = Db.update("update t_game set WINNER_ID=?, SCORE1=?, SCORE2=? where ID = ?", winId, score1, score2, gameId);
		return rs > 0;
	}
	
	/**
	 * 将用户移动到对应比赛
	 * @param matchId
	 * @param seq
	 * @param index
	 * @param userId
	 * @return
	 */
	public boolean moveUserToGame(int matchId, Integer seq, Integer index, Integer userId){
		int rs = Db.update("update t_game set USER" + index + "=? where MATCH_ID = ? and SEQ=?", userId, matchId, seq);
		return rs > 0;
	}
	
	public List<Game> sordMatch(int matchId){
		//List<Game> userList = new ArrayList<Game>();
		String sql = "select WINNER_NAME, USER_ID, winNum from (select u.NAME as WINNER_NAME, count(g.id) as winNum, u.id as USER_ID from t_game g, t_user u where g.WINNER_ID = u.ID and g.MATCH_ID = "+matchId+" group by g.WINNER_ID) temp order by winNum desc ";
//		userList = Db.query(sql);
		return dao.find(sql);
	}
	
	public String[] getMatchHis(int matchId, int userId){
		StringBuffer sql = new StringBuffer("select flag, seq from ( select 'win' as flag, seq, t1.WINNER_ID as userId from t_game t1 where t1.MATCH_ID = ");
		sql.append(matchId).append(" and t1.WINNER_ID = ").append(userId);
		sql.append(" union all select 'loser' as flag, seq, if(t2.USER1 = t2.WINNER_ID, t2.USER2, t2.USER1 ) as userid from t_game t2 where t2.MATCH_ID = ");
		sql.append(matchId).append(" and t2.WINNER_ID != ").append(userId).append(" and (t2.USER1 = ").append(userId);
		sql.append(" or t2.USER2 = ").append(userId).append(" ) ) as t3 order by seq");
		List<Game> userList = new ArrayList<Game>();
		//userList = Db.query(sql.toString());
		userList = dao.find(sql.toString());
		String[] strArray = new String[userList.size()];
		for(int i=0;i<userList.size();i++){
			Game game = userList.get(i);
			strArray[i]=game.getFlag();
		}
		return strArray;
	}

	public void setU1_SEQ(Long seq) {
		set("U1_SEQ", seq);
	}
	
	public Long getU1_SEQ() {
		return get("U1_SEQ");
	}
	
	public void setU2_SEQ(Long seq) {
		set("U2_SEQ", seq);
	}
	
	public Long getU2_SEQ() {
		return get("U2_SEQ");
	}
	
	public void setU1_NAME(String name) {
		set("U1_NAME", name);
	}
	
	public String getU1_NAME() {
		return get("U1_NAME");
	}
	
	public void setU2_NAME(String name) {
		set("U2_NAME", name);
	}
	
	public String getU2_NAME() {
		return get("U2_NAME");
	}
	
	public void setUSER_ID(int userId) {
		set("USER_ID", userId);
	}
	
	public int getUSER_ID() {
		return get("USER_ID");
	}
	
	public void setWINNER_NAME(String name) {
		set("WINNER_NAME", name);
	}
	
	public String getWINNER_NAME() {
		return get("WINNER_NAME");
	}
	
	public void setWinNum(long winNum) {
		set("winNum", winNum);
	}
	
	public long getWinNum() {
		return get("winNum");
	}
	
	public void setFlag(String name) {
		set("flag", name);
	}
	
	public String getFlag() {
		return get("flag");
	}
	
	public String[] getMatchFlag(){
		return get("matchFlag");
	}
	
	public void setMatchFlag(String[] matchFlag){
		set("matchFlag",matchFlag);
	}
	
}
